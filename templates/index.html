<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKGCC International Business Summit 2025 - Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10">
            <header class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-800">HKGCC International Business Summit 2025</h1>
                <p class="text-gray-500 mt-2">Upload an image, choose a style, and create a unique vision for the summit!</p>
            </header>

            <main class="grid md:grid-cols-2 gap-8">
                <!-- Left Column: Inputs -->
                <div class="space-y-6">
                    <div>
                        <label for="image-upload" class="block text-sm font-medium text-gray-700 mb-1">Upload Image</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="flex text-sm text-gray-600">
                                    <label for="image-upload-input" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                        <span>Choose a file</span>
                                        <input id="image-upload-input" name="image-upload" type="file" class="sr-only" accept="image/*">
                                    </label>
                                    <p class="pl-1">or drag and drop</p>
                                </div>
                                <p class="text-xs text-gray-500" id="file-name">PNG, JPG up to 10MB</p>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label for="profession-select" class="block text-sm font-medium text-gray-700 mb-1">Choose a profession:</label>
                        <select id="profession-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="">Select a profession</option>
                            <option value="Pilot">Pilot</option>
                            <option value="Chef">Chef</option>
                            <option value="K-pop star">K-pop star</option>
                            <option value="Bartender">Bartender</option>
                            <option value="Footballer">Footballer</option>
                            <option value="Artist">Artist</option>
                            <option value="F1 Driver">F1 Driver</option>
                            <option value="Farmer">Farmer</option>
                        </select>
                    </div>
                    <button id="generate-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400">
                        Generate Image
                    </button>
                    <p class="text-xs text-gray-500 mt-2 text-left">If you encounter generation failure - it might due to high traffic, please try again later. <br>Please also ensure you follow our generation guidance <a href="https://policies.google.com/terms/generative-ai/use-policy?hl=en" class="text-indigo-600 hover:underline">here</a> to avoid failure.</p>
                </div>

                <!-- Right Column: Preview & Result -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-800">Preview & Result</h3>
                    <div id="image-preview-container" class="w-full aspect-square bg-gray-200 rounded-lg flex items-center justify-center overflow-hidden">
                        <span class="text-gray-500">Image Preview</span>
                    </div>
                    <div id="result-container" class="w-full aspect-square bg-gray-200 rounded-lg flex items-center justify-center overflow-hidden relative">
                         <div id="loader" class="loader hidden"></div>
                        <img id="result-image" src="" alt="Generated Image" class="hidden w-full h-full object-contain">
                        <span id="result-placeholder" class="text-gray-500">Generated image will appear here</span>
                    </div>
                    <!-- Mobile download tip -->
                    <p id="mobile-download-tip" class="text-center text-orange-700 bg-orange-100 font-medium p-2 rounded-lg text-sm mt-2 hidden md:hidden">
                        Press and hold the image to download
                    </p>
                    <!-- Desktop download tip (NEW) -->
                    <p id="desktop-download-tip" class="text-center text-orange-700 bg-orange-100 font-medium p-2 rounded-lg text-sm mt-2 hidden md:hidden">
                        Right-click and "Save image as..." to download
                    </p>
                </div>
            </main>

            <div id="message-box" class="fixed top-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
                <span id="message-text"></span>
            </div>
        </div>
        
        <!-- Disclaimer Footer -->
        <footer class="mt-6 text-xs text-gray-500 text-left space-y-2">
            <p><strong>Disclaimers:</strong> This demonstration site is intended for informational and illustrative purposes during this event only. All services are provided 'as-is' without warranties of any kind.</p>
            <p>AI-generated content may contain inaccuracies, artifacts, or offensive material. Please review all outputs carefully. Please refrain from entering any personal, confidential, or sensitive proprietary information, as inputs may be logged.</p>
            <p>Content generated from this site is for demonstration purposes only and is not licensed for commercial or public use. We assume no liability for any decisions or actions taken based on the content generated.</p>
        </footer>
    </div>

    <script>
        // --- DOM Elements ---
        const imageUploadInput = document.getElementById('image-upload-input');
        const fileNameDisplay = document.getElementById('file-name');
        const generateBtn = document.getElementById('generate-btn');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const resultContainer = document.getElementById('result-container');
        const loader = document.getElementById('loader');
        const resultImage = document.getElementById('result-image');
        const resultPlaceholder = document.getElementById('result-placeholder');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const mobileDownloadTip = document.getElementById('mobile-download-tip'); 
        const desktopDownloadTip = document.getElementById('desktop-download-tip'); // (NEW)
        const professionSelect = document.getElementById('profession-select');

        // --- State ---
        let uploadedFile = null;

        // --- System Prompt ---
        const systemPrompt = `
        Role: You are an expert AI visual artist. Generate a photorealistic, high-definition (4k) portrait for the "HKGCC International Business Summit 2025".

        CORE REQUIREMENT (FACE):
        The generated image MUST strictly maintain the facial features, identity, and likeness of the person in the uploaded photo. This is a Face Swap/Identity Preservation task. The face should be seamlessly integrated with the lighting and angle of the new scene.

        Global Style & Composition Constraints:
        1. Theme: Professional, slightly futuristic, "Shifting Economic Center of Gravity".
        2. Atmosphere: Sophisticated, energetic, highlighting Hong Kong's vibrancy.
        3. Composition: Medium shot (waist up) or Close-up. Subject centered.
        4. TEXT SAFE AREA: The bottom 20% of the image must be kept relatively dark or uncluttered to allow for a text banner overlay.
        `;
        // --- Prompts ---

        // const userPrompts = {
        //     "Pilot": "The person in the uploaded photo is a commercial pilot in full uniform, communicating with Air Traffic Control through their headset, right hand firmly on the thrust levers in a wide-body jet cockpit. They are focused out of the window on the runway ahead, as sunlight streams into the cockpit. The primary flight display shows pre-takeoff data. The image should be based on the facial features and likeness of the uploaded photo.",
        //     "Chef": "The person uploaded in the photo is in a close-up, warm-toned photograph, in a plain white chef's jacket, intensely focused on plating a gourmet dish. Their hand expertly places a delicate garnish with tweezers onto a beautifully arranged plate. The background is bustling, high-end kitchen. The expression is one of passion and precision. The image should be based on the facial features and likeness of the uploaded photo.",
        //     "K-pop star":"Transform the subject uploaded in the image into a singer performing on stage.  They have no background dancers, and are performing solo on a massive concert stage holding only one mic. The image should be based on the facial features and likeness of the uploaded photo. They are captured mid-performance, striking a powerful pose in the middle of a high energy pop music performance. They are wearing a cutting-edge, high-fashion stage outfit. The generated person should look exactly like the uploaded image. The image style is photorealistic and can be slightly grainy.",
        //     "Bartender":"A cinematic, low-light shot of the person in the uploaded photo as a cool, stylish bartender, vigorously shaking a cocktail shaker behind a busy, well-stocked bar. Their focus is on precise movement and technique. Blurred patrons and glowing liquor bottles form the background. The image should be based on the facial features and likeness of the uploaded photo.",
        //     "Footballer":"Turn the person in the uploaded image into a professional football player in a team uniform, sprinting across the pitch, shot from a low angle shot. They are powerfully striking the ball toward the goal during a crowded stadium match, showing pure athletic determination. The image should be based on the facial features and likeness of the uploaded photo.",
        //     "Artist": "A dynamic, natural light photograph of the person in the uploaded photo as a passionate artist, standing before a large, partially completed canvas. They are actively applying paint with a wide brush or palette knife, a splash of paint on their cheek. The studio is filled with natural light from a large window, with various art supplies casually arranged in the background. The image should be based on the facial features and likeness of the uploaded photo.",
        //     "F1 Driver":" The person in the uploaded photo as a professional F1 driver, helmet off, standing next to their car in the pit lane during a race weekend. They are looking directly at the camera with a determined, focused expression. The background shows blurred pit crew activity and the grandstand. Realistic photo. The generated person should look exactly like the image uploaded.",
        //     "Farmer":"A serene, full-body shot of the person in the image gently tending to plants in a beautiful, sun-drenched vegetable garden. They are kneeling, carefully inspecting ripe red strawberries or adjusting young vegetable sprouts. Soft, golden light illuminates the scene, highlighting lush green foliage, vibrant produce, and rich soil. This farmer should look exactly like the uploaded image"
        // };
        const userPrompts = {
        "Chef": `
            Subject: The person is an Executive Chef in a pristine white chef's uniform (with apron). 
            Action: They are intensely focused on plating a gourmet dish with tweezers, showing precision and mastery.
            Environment: A high-end, open-concept kitchen located in a skyscraper. Through the large floor-to-ceiling glass windows behind them, the iconic Hong Kong Victoria Harbour skyline is visible at night, blurring softly in the bokeh.
            Lighting: Crisp, cool studio lighting on the food and face, with warm ambient city lights in the background.
        `,
        "Bartender": `
            Subject: The person is a stylish, high-end Mixologist wearing a crisp vest and rolled-up dress shirt.
            Action: They are caught in a dynamic motion, shaking a silver cocktail shaker with ice flying slightly, looking confident and charming.
            Environment: An exclusive outdoor Rooftop Bar in Central Hong Kong. The background is the glittering IFC and ICC towers and neon city lights, creating a luxurious nightlife atmosphere.
            Lighting: Cinematic moody lighting, with purple and blue neon reflections on the shaker and the subject's clothes.
        `,

        "Artist": `
            Subject: The person is a contemporary artist holding a palette and a paintbrush, with a smudge of paint artfully on their cheek or apron.
            Action: They are standing next to an easel, pausing to look at the viewer with creative inspiration.
            Environment: A modern art studio loft with a massive panoramic window overlooking the Hong Kong night skyline. The city lights illuminate the canvas from behind.
            Lighting: Soft, artistic spotlight on the subject, contrasting with the vibrant city colors outside.
        `,

        "Farmer": `
            Subject: The person is a modern Urban Agritech Specialist wearing smart-casual workwear (maybe a utility shirt).
            Action: They are inspecting a high-tech vertical hydroponic system, holding a basket of fresh, perfect organic produce.
            Environment: A futuristic rooftop urban farm on top of a Hong Kong skyscraper. Green vertical plant walls frame the shot, but the background clearly shows the high-tech city skyline and night lights.
            Style: Merges nature with cyberpunk city aesthetics. Lush greens against steel and neon.
        `,
        
        "Pilot": `
            Subject: Commercial airline pilot in full uniform (epaulets, tie).
            Action: Sitting in the cockpit, hand on the thrust lever, looking confident.
            Environment: The cockpit windshield view shows the Hong Kong International Airport runway at night/dusk, with the city lights on the horizon.
            Lighting: Glow from the instrument panel illuminating the face.
        `,
        
        "K-pop star": `
            Subject: A charismatic Pop Star in a futuristic, high-fashion stage outfit.
            Action: Holding a microphone, singing passionately mid-performance.
            Environment: A massive outdoor concert stage at the Central Harbourfront Event Space. The backdrop is the real Hong Kong skyline lit up with laser beams.
            Lighting: Dramatic stage spotlights (lens flare), volumetric fog.
        `,
        
        "Footballer": `
            Subject: Professional football player in a jersey.
            Action: Standing confidently with a football under one arm, or adjusting their collar.
            Environment: Inside the Hong Kong Stadium at night, with floodlights blazing and a blurred crowd in the background.
            Lighting: High-contrast sports stadium lighting.
        `,
        
        "F1 Driver": `
            Subject: F1 Racing Driver in a racing suit (helmet held under arm).
            Action: Standing on the track (Central Harbourfront circuit), looking determined.
            Environment: The race track is set directly against the Hong Kong skyline at night. Blur of speed and city lights.
            Lighting: Sharp, heroic lighting.
        `
    };

        // --- Event Listeners ---
        imageUploadInput.addEventListener('change', handleImageUpload);
        generateBtn.addEventListener('click', handleGenerateImage);

        // --- Functions ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            uploadedFile = file;
            fileNameDisplay.textContent = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreviewContainer.innerHTML = `<img src="${e.target.result}" alt="Preview" class="w-full h-full object-contain">`;
            };
            reader.readAsDataURL(file);
        }

        async function handleGenerateImage() {
            const selectedProfession = professionSelect.value;
            if (!uploadedFile || !selectedProfession) {
                showMessage("Please upload an image and select a persona!", "error");
                return;
            }

            const userPromptText = userPrompts[selectedProfession];
            if (!userPromptText) {
                showMessage("Invalid persona selected!", "error");
                return;
            }

            const fullPrompt = systemPrompt + "\n" + userPromptText + " The image should be based on the facial features and likeness of the uploaded photo.";

            setLoading(true);
            resultImage.classList.add('hidden');
            resultPlaceholder.classList.add('hidden');
            mobileDownloadTip.classList.add('hidden'); // Hide tip
            
            // Reset desktop tip classes to be hidden everywhere
            desktopDownloadTip.classList.add('hidden'); 
            desktopDownloadTip.classList.add('md:hidden');
            desktopDownloadTip.classList.remove('md:block');

            try {
                const base64ImageData = await fileToBase64(uploadedFile);
                
                const apiUrl = `/generate`; 
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: fullPrompt },
                            { inlineData: { mimeType: uploadedFile.type, data: base64ImageData.split(',')[1] } }
                        ]
                    }]
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // 1. 嘗試解析 JSON，如果後端崩潰回傳 HTML，這裡會抓到錯誤
                let result;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    // 如果無法解析 JSON，通常代表後端嚴重崩潰 (回傳了 Nginx/Flask 預設 HTML)
                    throw new Error(`Backend Critical Failure (Non-JSON response). Status: ${response.status}`);
                }

                // 2. 針對 HTTP 狀態碼進行分類處理 (這是最重要的部分)
                if (!response.ok) {
                    const errorMsg = result.error?.message || JSON.stringify(result);
                    
                    // 圖片過大 (常見錯誤)
                    if (response.status === 413) {
                        throw new Error(`Image is too large (413). Please upload a smaller file.`);
                    }
                    // 權限或設定錯誤
                    if (response.status === 401 || response.status === 403) {
                        throw new Error(`API Key error or Unauthorized (401/403). Check server logs.`);
                    }
                    // 後端程式碼報錯 (你在 Python 裡的 Exception)
                    if (response.status === 500) {
                        throw new Error(`Server Internal Error (500): ${errorMsg}`);
                    }
                    // 上游 API (Gemini) 暫時無法使用
                    if (response.status === 503) {
                        throw new Error(`Service Unavailable. Gemini API might be overloaded.`);
                    }

                    // 其他錯誤
                    throw new Error(`API Request Failed (${response.status}): ${errorMsg}`);
                }

                console.log("Full API Response from backend:", JSON.stringify(result, null, 2));
                // 3. 檢查 Gemini 的業務邏輯錯誤 (成功連線，但沒產圖)
                // 檢查是否因為 Safety Filter 被擋
                const finishReason = result?.candidates?.[0]?.finishReason;
                if (finishReason !== 'STOP' && finishReason !== undefined) {
                     if (finishReason === 'SAFETY') {
                         throw new Error(`Blocked by Safety Filter. The AI detected sensitive content in your image or prompt.`);
                     }
                     if (finishReason === 'RECITATION') {
                         throw new Error(`Blocked by Copyright Filter (Recitation).`);
                     }
                     // 其他未知的結束原因
                     console.warn("Unusual finish reason:", finishReason);
                }
                const imagePart = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                const textPart = result?.candidates?.[0]?.content?.parts?.find(p => p.text);
                
                if (imagePart) {
                    const generatedImageBase64 = imagePart.inlineData.data;
                    const mimeType = imagePart.inlineData.mimeType;
                    resultImage.src = `data:${mimeType};base64,${generatedImageBase64}`;
                    resultImage.classList.remove('hidden');
                    mobileDownloadTip.classList.remove('hidden'); // Show tip
                    
                    // Show desktop tip *only* on desktop
                    desktopDownloadTip.classList.remove('md:hidden');
                    desktopDownloadTip.classList.add('md:block');
                    // 'hidden' class for mobile stays, so result is 'hidden md:block'

                    let caption = textPart ? textPart.text : "Visionary thoughts loading...";
                    showMessage(`Image generated successfully! Caption: ${caption}`);
                } else {
                    let detailedError = "No image data found in the API response.";
                    if (result?.candidates?.[0]?.finishReason === 'SAFETY') {
                        detailedError += " This might be due to the safety filter. Please try a different image or prompt.";
                    } else if (result.error) {
                        detailedError = result.error.message;
                    }
                    throw new Error(detailedError);
                }

            } catch (error) {
                console.error('Error generating image:', error);
                showMessage(`Generation failed: ${error.message}`, "error", 15000);
                resultPlaceholder.classList.remove('hidden');
            } finally {
                setLoading(false);
            }
        }

        function setLoading(isLoading) {
            generateBtn.disabled = isLoading;
            loader.classList.toggle('hidden', !isLoading);
        }

        function showMessage(text, type = 'success', duration = 10000) {
            messageText.innerHTML = text; // Use innerHTML to render HTML tags
            messageBox.className = 'fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-100 transition-opacity duration-300'; // Reset classes
            messageBox.classList.add(type === 'error' ? 'bg-red-500' : 'bg-blue-500');
            setTimeout(() => {
                messageBox.classList.replace('opacity-100', 'opacity-0');
            }, duration);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>

